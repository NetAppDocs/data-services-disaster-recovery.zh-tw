---
sidebar: sidebar 
permalink: use/failover.html 
keywords: disaster recovery, bluexp disaster recovery, failover, replicate, fail over, vmware, vcenter 
summary: NetApp災難復原是一種基於雲端的災難復原服務​​，可自動執行災難復原工作流程。 
---
= 使用NetApp災難復原將應用程式故障轉移到遠端站點
:hardbreaks:
:allow-uri-read: 
:icons: font
:imagesdir: ../media/use/


[role="lead"]
如果發生災難，請將您的主要本機 VMware 網站故障轉移到另一個本機 VMware 網站或 AWS 上的 VMware Cloud。您可以測試故障轉移過程以確保在需要時能夠成功。

*所需的NetApp控制台角色* 組織管理員、資料夾或專案管理員、災難復原管理員或災難復原故障轉移管理員角色。

link:../reference/dr-reference-roles.html["了解NetApp災難復原中的使用者角色和權限"] 。https://docs.netapp.com/us-en/bluexp-setup-admin/reference-iam-predefined-roles.html["了解所有服務的NetApp控制台存取角色"^] 。

*關於此任務*

在故障轉移期間，災難復原使用最新的SnapMirror快照副本。或者，您可以從時間點快照中選擇特定快照（根據SnapMirror的保留策略）。

如果最近的副本受到威脅（例如在勒索軟體攻擊期間），請使用時間點選項。  BlueXP disaster recovery顯示所有可用的時間點。

此過程會有所不同，具體取決於生產站點是否健康以及您是否由於關鍵基礎設施故障以外的原因執行到災難復原站點的故障轉移：

* 發生嚴重生產站點故障，導致無法存取來源 vCenter 或ONTAP叢集： NetApp災難復原可讓您選擇任何可用的快照進行復原。
* 生產環境健康：您可以「立即拍攝快照」或選擇先前建立的快照。


此程序會中斷複製關係，將 vCenter 來源虛擬機置於離線狀態，將磁碟區註冊為災難復原 vCenter 中的資料儲存區，使用計畫中的故障轉移規則重新啟動受保護的虛擬機，並在目標網站上啟用讀取/寫入功能。



== 測試故障轉移過程

在開始故障轉移之前，您可以測試流程。測試不會使虛擬機器離線。

在故障轉移測試期間， BlueXP disaster recovery會暫時建立虛擬機器。  BlueXP disaster recovery將支援FlexClone磁碟區的暫存資料儲存對應到 ESXi 主機。

此程序不會消耗本地ONTAP儲存或 AWS 中 FSx for NetApp ONTAP儲存的額外實體容量。原始來源磁碟區不會被修改，即使在災難復原期間，副本作業也可以繼續。

完成測試後，您應該使用*清理測試*選項重設虛擬機器。雖然建議這樣做，但這不是必要的。

測試故障轉移作業不會影響生產工作負載、測試站點上使用的SnapMirror關係以及必須繼續正常運作的受保護工作負載。

對於測試故障轉移，災難復原執行以下操作：

* 對目標叢集和SnapMirror關係執行預檢查。
* 從選定的快照為目標站點ONTAP叢集上的每個受保護的ONTAP磁碟區建立一個新的FlexClone區。
* 如果任何資料儲存都是 VMFS，則建立一個 iGroup 並將其對應到每個 LUN。
* 將目標虛擬機器在 vCenter 中註冊為新的資料儲存區。
* 根據資源組頁面中擷取的啟動順序啟動目標虛擬機器。
* 取消停頓虛擬機器中任何被標記為「應用程式一致」的受支援的資料庫應用程式。
* 如果來源 vCenter 和ONTAP叢集仍處於活動狀態，請建立反向SnapMirror關係，以將故障轉移狀態下的任何變更複製回原始來源網站。


.步驟
. 登入 https://console.netapp.com/["NetApp控制台"^]。
. 從NetApp控制台左側導覽中，選擇 *保護* > *災難復原*。
. 從NetApp災難復原選單中，選擇 *複製計畫*。
. 選擇複製計劃。
. 在右側，選擇“操作”選項image:../use/icon-horizontal-dots.png["NetApp災難復原服務​​中的操作選單圖標"]並選擇*測試故障轉移*。
. 在測試故障轉移頁面中，輸入「測試故障轉移」並選擇*測試故障轉移*。
. 測試完成後，清理測試環境。




== 故障轉移測試後清理測試環境

故障轉移測試完成後，您應該清理測試環境。此程序將從測試位置、FlexClone 和暫存資料儲存區中刪除暫存虛擬機器。

.步驟
. 從NetApp災難復原選單中，選擇 *複製計畫*。
. 選擇複製計劃。
. 在右側，選擇“操作”選項image:../use/icon-horizontal-dots.png["NetApp災難復原服務​​中的操作選單圖標"]並選擇*清理故障轉移測試*。
. 在測試故障轉移頁面中，輸入“清理故障轉移”，並選擇*清理故障轉移測試*。




== 將來源站點故障轉移到災難復原站點

如果發生災難，您可以根據需要將主要本機 VMware 站點故障轉移到另一個本機 VMware 站點或使用 FSx for NetApp ONTAP 的AWS 上的 VMware Cloud。

故障轉移過程涉及以下操作：

* 災難復原對目標叢集和SnapMirror關係執行預檢查。
* 如果您選擇了最新的快照，則會執行SnapMirror更新以複製最新的變更。
* 來源虛擬機器已關閉。
* SnapMirror關係已中斷，目標磁碟區變為讀取/寫入。
* 根據快照的選擇，活動檔案系統將恢復到指定的快照（最新或選定）。
* 根據複製計畫中擷取的資訊建立資料儲存並將其安裝到 VMware 或 VMC 叢集或主機。如果任何資料儲存都是 VMFS，則建立一個 iGroup 並將其對應到每個 LUN。
* 目標虛擬機器在 vCenter 中註冊為新的資料儲存區。
* 目標虛擬機器會根據資源組頁面中擷取的啟動順序啟動。
* 如果來源 vCenter 仍處於活動狀態，請關閉所有正在進行故障轉移的來源端虛擬機器。
* 取消停頓虛擬機器中任何被標記為「應用程式一致」的受支援的資料庫應用程式。
* 如果來源 vCenter 和ONTAP叢集仍處於活動狀態，請建立反向SnapMirror關係，以便在故障轉移狀態下將任何變更複製回原始來源網站。  SnapMirror關係從目標虛擬機器到來源虛擬機器是相反的。



TIP: 故障轉移啟動後，您可以在災難復原站點的 vCenter 中看到復原的虛擬機器（虛擬機器、網路和資料儲存）。預設情況下，虛擬機會恢復到 Workload 資料夾。

.步驟
. 從NetApp災難復原選單中，選擇 *複製計畫*。
. 選擇複製計劃。
. 在右側，選擇“操作”選項image:../use/icon-horizontal-dots.png["NetApp災難復原服務​​中的操作選單圖標"]並選擇*故障轉移*。
+
image:dr-plan-failover3.png["故障轉移頁面"]

. 在故障轉移頁面中，立即啟動快照或選擇要從中復原的資料儲存體的快照。預設是最新的。
+
在發生故障轉移之前，將拍攝目前來源的快照並將其複製到目前目標。

. 或者，如果您希望在偵測到通常會阻止故障轉移發生的錯誤時仍進行故障轉移，請選擇「*強制故障轉移*」。
. 或者，如果您希望服務在複製計劃故障轉移後不自動建立反向SnapMirror保護關係，請選擇「*跳過保護*」。如果您想在NetApp災難復原中將復原的網站還原上線之前對其執行其他操作，這將非常有用。
+

TIP: 您可以從複製計劃操作選單中選擇*保護資源*來建立反向保護。這會嘗試為計劃中的每個磁碟區建立反向複製關係。您可以重複執行此作業，直到恢復保護。當保護恢復後，您可以按照通常的方式啟動故障恢復。

. 在方塊中輸入「故障轉移」。
. 選擇*故障轉移*。
. 若要檢查進度，請在選單中選擇*作業監控*。

